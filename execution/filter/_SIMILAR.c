//
// Created by wangpengyu6 on 18-7-16.
//


#include "filters.h"

#define HIK_VCA_LIB_S_OK                     1           //成功
#define HIKFR_LIB_NOT_SUPPORT_VERSION      0x80007004    // 非算法库支持的比对版本

#define ALIGNTO(n)      __attribute__((aligned(n))) //内存对齐
#define TAG_LEN         16
#define SIG_LUT_LEN         800
#define FEAT_DIM        512
#define SIG_START_VAL      (-10)
#define SIG_INTER           0.02
#define LUT_STEP            50
#define SIG_TAIL_SCALE      0.0001f
#define FR_FLOOR(a)        (int)(a)

#define BETA        0
#define SCALE       12.5978f
#define BIAS        (-4.2008)   //dfr2.4.3

#define SIM_REPROCESS

#ifdef IS_INT4_FEAT
#define		ALPHA	1.0f
#else
#define        ALPHA    (1.0f/1024.0f/1024.0f)
#endif

static const float FR_CONST_SIGMOID_LUT[SIG_LUT_LEN + 1] = {
        0.0000454f, 0.0000463f, 0.0000473f, 0.0000482f, 0.0000492f, 0.0000502f, 0.0000512f, 0.0000522f, 0.0000533f,
        0.0000544f,
        0.0000554f, 0.0000566f, 0.0000577f, 0.0000589f, 0.0000601f, 0.0000613f, 0.0000625f, 0.0000638f, 0.0000651f,
        0.0000664f,
        0.0000677f, 0.0000691f, 0.0000705f, 0.0000719f, 0.0000734f, 0.0000748f, 0.0000764f, 0.0000779f, 0.0000795f,
        0.0000811f,
        0.0000827f, 0.0000844f, 0.0000861f, 0.0000878f, 0.0000896f, 0.0000914f, 0.0000933f, 0.0000951f, 0.0000971f,
        0.0000990f,
        0.0001010f, 0.0001031f, 0.0001052f, 0.0001073f, 0.0001094f, 0.0001117f, 0.0001139f, 0.0001162f, 0.0001186f,
        0.0001210f,
        0.0001234f, 0.0001259f, 0.0001284f, 0.0001310f, 0.0001337f, 0.0001364f, 0.0001391f, 0.0001419f, 0.0001448f,
        0.0001477f,
        0.0001507f, 0.0001538f, 0.0001569f, 0.0001600f, 0.0001633f, 0.0001666f, 0.0001699f, 0.0001734f, 0.0001769f,
        0.0001804f,
        0.0001841f, 0.0001878f, 0.0001916f, 0.0001955f, 0.0001994f, 0.0002034f, 0.0002075f, 0.0002117f, 0.0002160f,
        0.0002204f,
        0.0002248f, 0.0002294f, 0.0002340f, 0.0002387f, 0.0002435f, 0.0002485f, 0.0002535f, 0.0002586f, 0.0002638f,
        0.0002691f,
        0.0002746f, 0.0002801f, 0.0002858f, 0.0002916f, 0.0002974f, 0.0003034f, 0.0003096f, 0.0003158f, 0.0003222f,
        0.0003287f,
        0.0003354f, 0.0003421f, 0.0003490f, 0.0003561f, 0.0003633f, 0.0003706f, 0.0003781f, 0.0003857f, 0.0003935f,
        0.0004015f,
        0.0004096f, 0.0004178f, 0.0004263f, 0.0004349f, 0.0004437f, 0.0004526f, 0.0004618f, 0.0004711f, 0.0004806f,
        0.0004903f,
        0.0005002f, 0.0005103f, 0.0005206f, 0.0005311f, 0.0005418f, 0.0005528f, 0.0005639f, 0.0005753f, 0.0005869f,
        0.0005988f,
        0.0006109f, 0.0006232f, 0.0006358f, 0.0006486f, 0.0006617f, 0.0006751f, 0.0006887f, 0.0007026f, 0.0007168f,
        0.0007313f,
        0.0007460f, 0.0007611f, 0.0007765f, 0.0007921f, 0.0008081f, 0.0008244f, 0.0008411f, 0.0008580f, 0.0008754f,
        0.0008930f,
        0.0009111f, 0.0009294f, 0.0009482f, 0.0009673f, 0.0009869f, 0.0010068f, 0.0010271f, 0.0010478f, 0.0010690f,
        0.0010905f,
        0.0011125f, 0.0011350f, 0.0011579f, 0.0011813f, 0.0012051f, 0.0012294f, 0.0012542f, 0.0012795f, 0.0013053f,
        0.0013317f,
        0.0013585f, 0.0013859f, 0.0014139f, 0.0014424f, 0.0014715f, 0.0015012f, 0.0015315f, 0.0015624f, 0.0015939f,
        0.0016260f,
        0.0016588f, 0.0016923f, 0.0017264f, 0.0017612f, 0.0017967f, 0.0018329f, 0.0018699f, 0.0019076f, 0.0019461f,
        0.0019853f,
        0.0020253f, 0.0020662f, 0.0021078f, 0.0021503f, 0.0021936f, 0.0022378f, 0.0022830f, 0.0023290f, 0.0023759f,
        0.0024238f,
        0.0024726f, 0.0025224f, 0.0025733f, 0.0026251f, 0.0026780f, 0.0027320f, 0.0027870f, 0.0028431f, 0.0029004f,
        0.0029588f,
        0.0030184f, 0.0030792f, 0.0031412f, 0.0032045f, 0.0032690f, 0.0033348f, 0.0034019f, 0.0034704f, 0.0035403f,
        0.0036116f,
        0.0036842f, 0.0037584f, 0.0038340f, 0.0039112f, 0.0039899f, 0.0040701f, 0.0041520f, 0.0042355f, 0.0043207f,
        0.0044076f,
        0.0044963f, 0.0045867f, 0.0046789f, 0.0047730f, 0.0048689f, 0.0049668f, 0.0050666f, 0.0051685f, 0.0052723f,
        0.0053782f,
        0.0054863f, 0.0055965f, 0.0057089f, 0.0058236f, 0.0059405f, 0.0060598f, 0.0061815f, 0.0063055f, 0.0064321f,
        0.0065612f,
        0.0066929f, 0.0068271f, 0.0069641f, 0.0071038f, 0.0072462f, 0.0073915f, 0.0075397f, 0.0076909f, 0.0078450f,
        0.0080022f,
        0.0081626f, 0.0083261f, 0.0084929f, 0.0086629f, 0.0088364f, 0.0090133f, 0.0091937f, 0.0093777f, 0.0095653f,
        0.0097567f,
        0.0099518f, 0.0101508f, 0.0103537f, 0.0105607f, 0.0107717f, 0.0109869f, 0.0112064f, 0.0114302f, 0.0116584f,
        0.0118911f,
        0.0121284f, 0.0123704f, 0.0126172f, 0.0128688f, 0.0131253f, 0.0133869f, 0.0136537f, 0.0139256f, 0.0142030f,
        0.0144857f,
        0.0147740f, 0.0150680f, 0.0153677f, 0.0156733f, 0.0159848f, 0.0163025f, 0.0166264f, 0.0169565f, 0.0172932f,
        0.0176363f,
        0.0179862f, 0.0183429f, 0.0187065f, 0.0190772f, 0.0194551f, 0.0198403f, 0.0202330f, 0.0206333f, 0.0210413f,
        0.0214573f,
        0.0218813f, 0.0223134f, 0.0227539f, 0.0232029f, 0.0236606f, 0.0241270f, 0.0246024f, 0.0250870f, 0.0255808f,
        0.0260841f,
        0.0265970f, 0.0271197f, 0.0276524f, 0.0281953f, 0.0287485f, 0.0293122f, 0.0298867f, 0.0304720f, 0.0310685f,
        0.0316762f,
        0.0322955f, 0.0329264f, 0.0335692f, 0.0342242f, 0.0348914f, 0.0355712f, 0.0362637f, 0.0369692f, 0.0376879f,
        0.0384200f,
        0.0391657f, 0.0399253f, 0.0406991f, 0.0414871f, 0.0422898f, 0.0431073f, 0.0439398f, 0.0447877f, 0.0456512f,
        0.0465305f,
        0.0474259f, 0.0483376f, 0.0492660f, 0.0502113f, 0.0511737f, 0.0521536f, 0.0531511f, 0.0541667f, 0.0552005f,
        0.0562529f,
        0.0573242f, 0.0584146f, 0.0595244f, 0.0606539f, 0.0618035f, 0.0629734f, 0.0641639f, 0.0653753f, 0.0666080f,
        0.0678623f,
        0.0691384f, 0.0704367f, 0.0717575f, 0.0731012f, 0.0744679f, 0.0758582f, 0.0772722f, 0.0787103f, 0.0801729f,
        0.0816603f,
        0.0831727f, 0.0847106f, 0.0862742f, 0.0878639f, 0.0894801f, 0.0911230f, 0.0927930f, 0.0944904f, 0.0962155f,
        0.0979688f,
        0.0997505f, 0.1015609f, 0.1034005f, 0.1052694f, 0.1071681f, 0.1090968f, 0.1110560f, 0.1130458f, 0.1150667f,
        0.1171190f,
        0.1192029f, 0.1213188f, 0.1234670f, 0.1256479f, 0.1278616f, 0.1301085f, 0.1323889f, 0.1347031f, 0.1370513f,
        0.1394339f,
        0.1418511f, 0.1443031f, 0.1467903f, 0.1493129f, 0.1518712f, 0.1544653f, 0.1570955f, 0.1597620f, 0.1624651f,
        0.1652049f,
        0.1679816f, 0.1707955f, 0.1736466f, 0.1765353f, 0.1794615f, 0.1824255f, 0.1854274f, 0.1884673f, 0.1915453f,
        0.1946616f,
        0.1978161f, 0.2010090f, 0.2042403f, 0.2075101f, 0.2108183f, 0.2141650f, 0.2175502f, 0.2209739f, 0.2244360f,
        0.2279365f,
        0.2314752f, 0.2350522f, 0.2386673f, 0.2423204f, 0.2460113f, 0.2497399f, 0.2535060f, 0.2573095f, 0.2611500f,
        0.2650274f,
        0.2689414f, 0.2728918f, 0.2768782f, 0.2809003f, 0.2849579f, 0.2890505f, 0.2931778f, 0.2973393f, 0.3015348f,
        0.3057637f,
        0.3100255f, 0.3143199f, 0.3186463f, 0.3230041f, 0.3273930f, 0.3318122f, 0.3362613f, 0.3407396f, 0.3452465f,
        0.3497815f,
        0.3543437f, 0.3589326f, 0.3635475f, 0.3681876f, 0.3728522f, 0.3775407f, 0.3822521f, 0.3869858f, 0.3917410f,
        0.3965168f,
        0.4013123f, 0.4061269f, 0.4109596f, 0.4158095f, 0.4206757f, 0.4255575f, 0.4304538f, 0.4353637f, 0.4402864f,
        0.4452208f,
        0.4501660f, 0.4551211f, 0.4600851f, 0.4650571f, 0.4700359f, 0.4750208f, 0.4800107f, 0.4850045f, 0.4900013f,
        0.4950002f,
        0.5000000f, 0.5049998f, 0.5099987f, 0.5149955f, 0.5199893f, 0.5249792f, 0.5299641f, 0.5349429f, 0.5399149f,
        0.5448789f,
        0.5498340f, 0.5547792f, 0.5597136f, 0.5646363f, 0.5695462f, 0.5744425f, 0.5793243f, 0.5841905f, 0.5890404f,
        0.5938731f,
        0.5986877f, 0.6034832f, 0.6082590f, 0.6130142f, 0.6177479f, 0.6224593f, 0.6271478f, 0.6318124f, 0.6364525f,
        0.6410674f,
        0.6456563f, 0.6502185f, 0.6547535f, 0.6592604f, 0.6637387f, 0.6681878f, 0.6726070f, 0.6769959f, 0.6813537f,
        0.6856801f,
        0.6899745f, 0.6942363f, 0.6984652f, 0.7026607f, 0.7068222f, 0.7109495f, 0.7150421f, 0.7190997f, 0.7231218f,
        0.7271082f,
        0.7310586f, 0.7349726f, 0.7388500f, 0.7426905f, 0.7464940f, 0.7502601f, 0.7539887f, 0.7576796f, 0.7613327f,
        0.7649478f,
        0.7685248f, 0.7720635f, 0.7755640f, 0.7790261f, 0.7824498f, 0.7858350f, 0.7891817f, 0.7924899f, 0.7957597f,
        0.7989910f,
        0.8021839f, 0.8053384f, 0.8084547f, 0.8115327f, 0.8145726f, 0.8175745f, 0.8205385f, 0.8234647f, 0.8263534f,
        0.8292045f,
        0.8320184f, 0.8347951f, 0.8375349f, 0.8402380f, 0.8429045f, 0.8455347f, 0.8481288f, 0.8506871f, 0.8532097f,
        0.8556969f,
        0.8581489f, 0.8605661f, 0.8629487f, 0.8652969f, 0.8676111f, 0.8698915f, 0.8721384f, 0.8743521f, 0.8765330f,
        0.8786812f,
        0.8807971f, 0.8828810f, 0.8849333f, 0.8869542f, 0.8889440f, 0.8909032f, 0.8928319f, 0.8947306f, 0.8965995f,
        0.8984391f,
        0.9002495f, 0.9020312f, 0.9037845f, 0.9055096f, 0.9072070f, 0.9088770f, 0.9105199f, 0.9121361f, 0.9137258f,
        0.9152894f,
        0.9168273f, 0.9183397f, 0.9198271f, 0.9212897f, 0.9227278f, 0.9241418f, 0.9255321f, 0.9268988f, 0.9282425f,
        0.9295633f,
        0.9308616f, 0.9321377f, 0.9333920f, 0.9346247f, 0.9358361f, 0.9370266f, 0.9381965f, 0.9393461f, 0.9404756f,
        0.9415854f,
        0.9426758f, 0.9437471f, 0.9447995f, 0.9458333f, 0.9468489f, 0.9478464f, 0.9488263f, 0.9497887f, 0.9507340f,
        0.9516624f,
        0.9525741f, 0.9534695f, 0.9543488f, 0.9552123f, 0.9560602f, 0.9568927f, 0.9577102f, 0.9585129f, 0.9593009f,
        0.9600747f,
        0.9608343f, 0.9615800f, 0.9623121f, 0.9630308f, 0.9637363f, 0.9644288f, 0.9651086f, 0.9657758f, 0.9664308f,
        0.9670736f,
        0.9677045f, 0.9683238f, 0.9689315f, 0.9695280f, 0.9701133f, 0.9706878f, 0.9712515f, 0.9718047f, 0.9723476f,
        0.9728803f,
        0.9734030f, 0.9739159f, 0.9744192f, 0.9749130f, 0.9753976f, 0.9758730f, 0.9763394f, 0.9767971f, 0.9772461f,
        0.9776866f,
        0.9781187f, 0.9785427f, 0.9789587f, 0.9793667f, 0.9797670f, 0.9801597f, 0.9805449f, 0.9809228f, 0.9812935f,
        0.9816571f,
        0.9820138f, 0.9823637f, 0.9827068f, 0.9830435f, 0.9833736f, 0.9836975f, 0.9840152f, 0.9843267f, 0.9846323f,
        0.9849320f,
        0.9852260f, 0.9855143f, 0.9857970f, 0.9860744f, 0.9863463f, 0.9866131f, 0.9868747f, 0.9871312f, 0.9873828f,
        0.9876296f,
        0.9878716f, 0.9881089f, 0.9883416f, 0.9885698f, 0.9887936f, 0.9890131f, 0.9892283f, 0.9894393f, 0.9896463f,
        0.9898492f,
        0.9900482f, 0.9902433f, 0.9904347f, 0.9906223f, 0.9908063f, 0.9909867f, 0.9911636f, 0.9913371f, 0.9915071f,
        0.9916739f,
        0.9918374f, 0.9919978f, 0.9921550f, 0.9923091f, 0.9924603f, 0.9926085f, 0.9927538f, 0.9928962f, 0.9930359f,
        0.9931729f,
        0.9933071f, 0.9934388f, 0.9935679f, 0.9936945f, 0.9938185f, 0.9939402f, 0.9940595f, 0.9941764f, 0.9942911f,
        0.9944035f,
        0.9945137f, 0.9946218f, 0.9947277f, 0.9948315f, 0.9949334f, 0.9950332f, 0.9951311f, 0.9952270f, 0.9953211f,
        0.9954133f,
        0.9955037f, 0.9955924f, 0.9956793f, 0.9957645f, 0.9958480f, 0.9959299f, 0.9960101f, 0.9960888f, 0.9961660f,
        0.9962416f,
        0.9963158f, 0.9963884f, 0.9964597f, 0.9965296f, 0.9965981f, 0.9966652f, 0.9967310f, 0.9967955f, 0.9968588f,
        0.9969208f,
        0.9969816f, 0.9970412f, 0.9970996f, 0.9971569f, 0.9972130f, 0.9972680f, 0.9973220f, 0.9973749f, 0.9974267f,
        0.9974776f,
        1.0000000f};

ALIGNTO(32) static const char tag[TAG_LEN] = "HIKDFR32105TX";//{'H', 'I', 'K', 'D', 'F', 'R', '3', '2', 'X', 0, 0, 0, 0, 0, 0, 0};  //版本号

#define MODEL_LEN 512
#define AVX_TRUE 0xffffffffffffffff

float compare(ColumnVector *vector, long rowId, FILTER *filter) {

    const char *src = vector->childColumns->data + rowId * (MODEL_LEN + TAG_LEN);
    const char *dst = filter->value;

#ifdef __AVX2__
    __m128i src_check = _mm_cmpeq_epi8(*(__m128i *) src, *(__m128i *) tag);
    __m128i dst_check = _mm_cmpeq_epi8(*(__m128i *) dst, *(__m128i *) tag);
    int64_t *check_src = (int64_t *) &src_check;
    int64_t *check_dst = (int64_t *) &dst_check;

    if (check_src[0] == AVX_TRUE && check_src[1] == AVX_TRUE && check_dst[0] == AVX_TRUE &&
        check_dst[1] == AVX_TRUE) {
#else
        int64_t *src_check = (int64_t *) src;
        int64_t *dst_check = (int64_t *) dst;
        if (src_check[0] == dst_check[0] && src_check[1] == dst_check[1]) {
#endif

#ifdef __AVX2__
        src += TAG_LEN;
        dst += TAG_LEN;
//        (*env)->GetByteArrayRegion(env, feat1, TAG_LEN, MODEL_LEN, src);
//        (*env)->GetByteArrayRegion(env, feat2, TAG_LEN, MODEL_LEN, dst);

        __m256i sum = _mm256_setzero_si256();
        int *p = (int *) &sum;

        //计算点积
        init_sum;
        sum256(src, dst, 32 * 0, sum);
        sum256(src, dst, 32 * 1, sum);
        sum256(src, dst, 32 * 2, sum);
        sum256(src, dst, 32 * 3, sum);

        sum256(src, dst, 32 * 4, sum);
        sum256(src, dst, 32 * 5, sum);
        sum256(src, dst, 32 * 6, sum);
        sum256(src, dst, 32 * 7, sum);

        sum256(src, dst, 32 * 8, sum);
        sum256(src, dst, 32 * 9, sum);
        sum256(src, dst, 32 * 10, sum);
        sum256(src, dst, 32 * 11, sum);

        sum256(src, dst, 32 * 12, sum);
        sum256(src, dst, 32 * 13, sum);
        sum256(src, dst, 32 * 14, sum);
        sum256(src, dst, 32 * 15, sum);

        //拉伸  求相似度
        const int s = (p[0] + p[1] + p[2] + p[3] + p[4] + p[5] + p[6] + p[7]);
#else
        src += TAG_LEN;
        dst += TAG_LEN;
        int i;
        int s=0;
        for (i = 0; i < FEAT_DIM; ++i) {
            s += src[i] * dst[i];
        }
#endif

        float f_res = (float) s * ALPHA;

#ifdef SIM_REPROCESS
        f_res = f_res * SCALE + BIAS;
        float idx_val = (f_res - SIG_START_VAL) * LUT_STEP;
        if ((idx_val < 0) || (idx_val > SIG_LUT_LEN - 1)) {
            return (idx_val < 0) ? 0.0f : 1.0f;
        }
        const int f_idx = FR_FLOOR(idx_val);
        const float tail = idx_val - f_idx;
        float new_val = FR_CONST_SIGMOID_LUT[f_idx];
        new_val += tail * (FR_CONST_SIGMOID_LUT[f_idx + 1] - FR_CONST_SIGMOID_LUT[f_idx]);
        f_res = new_val;
#endif
        return f_res;
    } else {
//模型不合法
        return HIKFR_LIB_NOT_SUPPORT_VERSION;
    }
}
